
\RequirePackage{atbegshi}
\RequirePackage{tikz}
\usetikzlibrary{backgrounds}
\RequirePackage{etoolbox}
\RequirePackage{zref-abspos}

\newcommand\tikzpagemark[1]{%
    \leavevmode
    \zsavepos{tikzpagemark-#1}%
}

\newcommand\tikzpagelayer[3][foreground]{%
    \tikzpagelayeron
    \stepcounter{tikzpagemark}%
    \tikzpagemark{\thetikzpagemark-begin}%
    \csxappto{tikzpagelayer@#1}{%
        \noexpand\set@tikzpagemark{\thetikzpagemark}%
        \unexpanded{#2}%
    }%
    #3%
    \tikzpagemark{\thetikzpagemark-end}%
}

\def\set@tikzpagemark#1{%
    \coordinate (tplbegin) at ([shift={(\zposx{tikzpagemark-#1-begin}sp,\zposy{tikzpagemark-#1-begin}sp)}]current page.south west);
    \coordinate (tplend)   at ([shift={(\zposx{tikzpagemark-#1-end}sp,\zposy{tikzpagemark-#1-end}sp)}]current page.south west);
}

\newcounter{tikzpagemark}

\def\@tikzpagelayeron{%
    \AtBeginShipoutNext{\tikzpagelayer@atbeginshipout}%
    \global\let\tikzpagelayeron\relax
}
\let\tikzpagelayeron\@tikzpagelayeron
\let\tikzpagelayer@background\empty
\let\tikzpagelayer@foreground\empty

\def\tikzpagelayer@atbeginshipout{%
    \setbox\AtBeginShipoutBox\hbox{%
        \color@setgroup
        \begin{tikzpicture}[remember picture]%
            \path [use as bounding box] node [inner sep=0pt,outer sep=0pt] (PAGEBOX) {\box\AtBeginShipoutBox};
            \begin{pgfonlayer}{background}
            \begin{scope}%
                \tikzpagelayer@background
            \end{scope}%
            \end{pgfonlayer}
            \begin{scope}%
                \tikzpagelayer@foreground
            \end{scope}%
        \end{tikzpicture}%
        \color@endgroup
    }%
    \global\let\tikzpagelayer@background\empty
    \global\let\tikzpagelayer@foreground\empty
    \global\let\tikzpagelayeron\@tikzpagelayeron
}

